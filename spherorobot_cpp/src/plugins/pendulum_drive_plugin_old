#include <gazebo/common/Plugin.hh>
#include <gazebo_ros/node.hpp>
#include <rclcpp/rclcpp.hpp>
#include <gazebo/physics/Model.hh>
#include <gazebo/physics/Joint.hh>
#include <gazebo/physics/World.hh>
#include <std_msgs/msg/float64.hpp>

namespace gazebo
{
    class PendulumDrivePlugin : public ModelPlugin
    {
        private:
            physics::ModelPtr model_;
            physics::JointPtr motor_joint_;
            event::ConnectionPtr update_connection_;
            gazebo_ros::Node::SharedPtr node_;
            rclcpp::Subscription<std_msgs::msg::Float64>::SharedPtr torque_sub_;
            double target_torque_ = 0.0;

        public:
            void Load(physics::ModelPtr _model, sdf::ElementPtr _sdf) override
            {
                model_ = _model;
                
                motor_joint_ = model_->GetJoint("gear_joint");
                
                if (!motor_joint_) {
                    gzerr << "Не найден шарнир мотора ('gear_joint')!" << std::endl;
                    return;
                }
                node_ = gazebo_ros::Node::Get(_sdf);
                if (!rclcpp::ok()) {
                    rclcpp::init(0, nullptr);
                }
                
                torque_sub_ = node_->create_subscription<std_msgs::msg::Float64>(
                    "/motor_torque",
                    10,
                    [this](const std_msgs::msg::Float64::SharedPtr msg) {
                        target_torque_ = msg->data;
                    });

                update_connection_ = event::Events::ConnectWorldUpdateBegin(
                    std::bind(&PendulumDrivePlugin::OnUpdate, this));
            }

            void OnUpdate() {
                motor_joint_->SetForce(0, target_torque_);
            }
    };
    GZ_REGISTER_MODEL_PLUGIN(PendulumDrivePlugin)
}




// #include <gazebo/common/Plugin.hh>
// #include <gazebo_ros/node.hpp>
// #include <rclcpp/rclcpp.hpp>
// #include <gazebo/physics/Model.hh>
// #include <gazebo/physics/Joint.hh>
// #include <gazebo/physics/World.hh>
// #include <std_msgs/msg/float64.hpp>

// namespace gazebo
// {
//     class PendulumDrivePlugin : public ModelPlugin
//     {
//         private:
//             physics::ModelPtr model_;
//             physics::JointPtr gear_joint_;
//             physics::JointPtr shaft_joint_;
//             physics::JointPtr sphere_joint_;
//             event::ConnectionPtr update_connection_;
//             gazebo_ros::Node::SharedPtr node_;
//             rclcpp::Subscription<std_msgs::msg::Float64>::SharedPtr torque_sub_;
//             double target_torque_ = 0.0;
//             double gear_ratio_ = 1.33;

//         public:
//             void Load(physics::ModelPtr _model, sdf::ElementPtr _sdf) override
//             {
//                 model_ = _model;
                
//                 gear_joint_ = model_->GetJoint("gear_joint");
//                 shaft_joint_ = model_->GetJoint("shaft_joint");
//                 sphere_joint_ = model_->GetJoint("sphere_joint");
                
//                 if (!gear_joint_ || !shaft_joint_ || !sphere_joint_) {
//                     gzerr << "Не найден один из шарниров!" << std::endl;
//                     return;
//                 }
//                 if(_sdf->HasElement("gear_ratio"))
//                 {
//                     gear_ratio_ = _sdf->Get<double>("gear_ratio");
//                 }
//                 node_ = gazebo_ros::Node::Get(_sdf);
//                 if (!rclcpp::ok()) {
//                     rclcpp::init(0, nullptr);
//                 }
                
//                 torque_sub_ = node_->create_subscription<std_msgs::msg::Float64>(
//                     "/motor_torque",
//                     10,
//                     [this](const std_msgs::msg::Float64::SharedPtr msg) {
//                         target_torque_ = msg->data;
//                     });

//                 update_connection_ = event::Events::ConnectWorldUpdateBegin(
//                     std::bind(&PendulumDrivePlugin::OnUpdate, this));
//             }

//             void OnUpdate() {
//                 gear_joint_->SetForce(0, target_torque_);
//                 double gear_velocity = gear_joint_->GetVelocity(0);
//                 shaft_joint_->SetVelocity(0, -gear_velocity * gear_ratio_);
//                 double base_angle = sphere_joint_->Position(0);
//                 if (fabs(base_angle) > 0.1) { // Пороговый угол (настройте под ваш робот)
//                     shaft_joint_->SetForce(0, base_angle * 0.5); // Коэффициент 0.5 - настройте
//                 }
//             }
//     };
//     GZ_REGISTER_MODEL_PLUGIN(PendulumDrivePlugin)
// }